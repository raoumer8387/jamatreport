<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ zila }} - رپورٹ - جماعت اسلامی ضلعی رپورٹنگ سسٹم</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=4">
    <link rel="stylesheet" href="{{ url_for('static', filename='chart-styles.css') }}?v=4">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script>
        console.log('Head script loaded');
        
        // Fallback for Chart.js loading
        if (typeof Chart === 'undefined') {
            console.warn('Chart.js not loaded from CDN, trying alternative source...');
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js';
            script.onload = function() {
                console.log('Chart.js loaded from alternative source');
            };
            document.head.appendChild(script);
        }
    </script>
    <style>
        .view-toggle {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        
        .toggle-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .toggle-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .toggle-btn.active {
            background: #007bff;
            color: white;
        }
        
        .toggle-btn.inactive {
            background: #6c757d;
            color: white;
        }
        
        .toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .view-content {
            display: none;
        }
        
        .view-content.active {
            display: block;
        }
        
        .chart-container canvas {
            width: 100% !important;
            height: 100% !important;
            max-width: 100% !important;
            max-height: 100% !important;
            display: block !important;
        }
        
        .section-container {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
        }

        .data-table-container {
            flex: 1;
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #ddd;
            font-family: 'Noto Nastaliq Urdu', serif;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        .data-table td {
            background: #fff;
        }

        .graph-grid {
            flex: 2;
        }

        h3 {
            font-size: 32px !important;
            font-family: 'Noto Nastaliq Urdu', serif !important;
            font-weight: bold !important;
            color: #333 !important;
        }
        th {
            font-size: 18px !important;
            font-family: 'Noto Nastaliq Urdu', serif !important;
            font-weight: bold !important;
            color: #333 !important;
        }

        td {
            font-size: 24px !important;
            font-family: 'Noto Nastaliq Urdu', serif !important;
            font-weight: normal !important;
            color: #333 !important;
        }

    </style>
</head>
<body>
    <div class="container">
        <header class="dashboard-header">
            <div class="header-content">
                <h1>{{ zila }} کارکردگی رپورٹ</h1>
                <h1> رپورٹ  بابت  ماہ 1 اپریل - 30 جون</h1>
            </div>
            <div class="header-actions" style="display: flex; gap: 15px; align-items: center;">
                <a href="{{ url_for('dashboard') }}" class="dashboard-btn" style="background-color: #3498db; color: white; padding: 10px 20px; text-decoration: none; border-radius: 8px; font-weight: bold;">ڈیش بورڈ پر واپس جائیں</a>
                <a href="{{ url_for('logout') }}" class="logout-btn" style="background-color: #e74c3c; color: white; padding: 10px 20px; text-decoration: none; border-radius: 8px; font-weight: bold;">لاگ آؤٹ</a>
            </div>
        </header>

        <!-- View Toggle Section -->
        <div class="view-toggle">
            <div class="toggle-buttons">
                <button type="button" class="toggle-btn active" data-view="graphs">گراف دیکھیں</button>
                <button type="button" class="toggle-btn inactive" data-view="spider">مکمل گراف دیکھیں</button>
                <button type="button" class="toggle-btn inactive" data-view="report" id="report-btn">رپورٹ دیکھیں</button>
                <a href="{{ url_for('print_report', zila=zila) }}" class="download-btn" title="پی ڈی ایف ڈاؤن لوڈ کریں" style="display: inline-flex; align-items: center; justify-content: center; padding: 12px 24px; background-color: #27ae60; color: white; border-radius: 8px; text-decoration: none; font-weight: bold; transition: all 0.3s ease;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-left: 8px;">
                        <path d="M12 16L12 8M12 8L8 12M12 8L16 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M3 15V16C3 18.8284 3 20.2426 3.87868 21.1213C4.75736 22 6.17157 22 9 22H15C17.8284 22 19.2426 22 20.1213 21.1213C21 20.2426 21 18.8284 21 16V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    پی ڈی ایف ڈاؤن لوڈ
                </a>
            </div>
        </div>

        <!-- Graphs View -->
        <div id="graphs-view" class="view-content active">
            <div class="graphs-container">
                <!-- Tanzeemi Hayyat Section -->
                <div class="graph-section">
                    <h2>تنظیمی ہیٔت</h2>
                    <div class="section-container">
                        <!-- Data Table -->
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>شعبہ</th>
                                        <th>ہدف (سہ ماہی دوم)</th>
                                        <th>اختتام (سہ ماہی دوم/سہ ماہی اول)</th>
                                        <th>فیصد (سہ ماہی اول)</th>
                                        <th>فیصد (سہ ماہی دوم)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>بلاک کوڈ انچارجز</td>
                                        <td id="blockCodeTarget">-</td>
                                        <td id="blockCodeIzafa">-</td>
                                        <td id="blockCodePercentageQ1">-</td>
                                        <td id="blockCodePercentage">-</td>
                                    </tr>
                                    <tr>
                                        <td>نظام فجر</td>
                                        <td id="nizamFajarTarget">-</td>
                                        <td id="nizamFajarIzafa">-</td>
                                        <td id="nizamFajarPercentageQ1">-</td>
                                        <td id="nizamFajarPercentage">-</td>
                                    </tr>
                                    <tr>
                                        <td>عوامی کمیٹی</td>
                                        <td id="awaamiCommitteeTarget">-</td>
                                        <td id="awaamiCommitteeIzafa">-</td>
                                        <td id="awaamiCommitteePercentageQ1">-</td>
                                        <td id="awaamiCommitteePercentage">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- Bar Graphs -->
                        <div class="graph-grid">
                            <div class="graph-card">
                                <h3>بلاک کوڈ انچارجز تقرری</h3>
                                <div class="chart-container">
                                    <canvas id="blockCodeIkhtitamChart"></canvas>
                                </div>
                            </div>
                            <div class="graph-card">
                                <h3>نظام فجر قائم</h3>
                                <div class="chart-container">
                                    <canvas id="nizamFajarIkhtitamChart"></canvas>
                                </div>
                            </div>
                            <div class="graph-card">
                                <h3>عوامی کمیٹی قائم</h3>
                                <div class="chart-container">
                                    <canvas id="awaamiCommitteeIkhtitamChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Afradi Quwat Section -->
                <div class="graph-section">
                    <h2>افرادی قوت</h2>
                    <div class="section-container">
                        <!-- Data Table -->
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>شعبہ</th>
                                        <th>ہدف (سہ ماہی دوم)</th>
                                        <th>اضافہ (سہ ماہی دوم/سہ ماہی اول)</th>
                                        <th>فیصد (سہ ماہی دوم)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>ارکان</td>
                                        <td id="arkaanTarget">-</td>
                                        <td id="arkaanIzafa">-</td>
                                        <td id="arkaanPercentage">-</td>
                                    </tr>
                                    <tr>
                                        <td>امیدواران رکنیت</td>
                                        <td id="umeedwaranTarget">-</td>
                                        <td id="umeedwaranIzafa">-</td>
                                        <td id="umeedwaranPercentage">-</td>
                                    </tr>
                                    <tr>
                                        <td>کارکنان</td>
                                        <td id="karkunanTarget">-</td>
                                        <td id="karkunanIzafa">-</td>
                                        <td id="karkunanPercentage">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- Bar Graphs -->
                        <div class="graph-grid">
                            <div class="graph-card">
                                <h3>ارکان اضافہ</h3>
                                <div class="chart-container">
                                    <canvas id="arkaanChart"></canvas>
                                </div>
                            </div>
                            <div class="graph-card">
                                <h3>امیدواران رکنیت اضافہ</h3>
                                <div class="chart-container">
                                    <canvas id="umeedwaranChart"></canvas>
                                </div>
                            </div>
                            <div class="graph-card">
                                <h3>کارکنان اضافہ</h3>
                                <div class="chart-container">
                                    <canvas id="karkunanChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Combined Ijtimaat Section -->
                <div class="graph-section">
                    <h2>تنظیمی و دعوتی اجتماعات</h2>
                    <div class="section-container">
                        <!-- Data Table -->
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>شعبہ</th>
                                        <th>طے شدہ (سہ ماہی دوم)</th>
                                        <th>اختتام (سہ ماہی دوم/سہ ماہی اول)</th>
                                        <th>فیصد (سہ ماہی دوم)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>اجتماع کارکنان (حلقہ جات)</td>
                                        <td id="ijtimaKarkunanHalqajatPlanned">-</td>
                                        <td id="ijtimaKarkunanHalqajatHeld">-</td>
                                        <td id="ijtimaKarkunanHalqajatPercentage">-</td>
                                    </tr>
                                    <tr>
                                        <td>درس قرآن (حلقہ جات)</td>
                                        <td id="darsQuranPlanned">-</td>
                                        <td id="darsQuranHeld">-</td>
                                        <td id="darsQuranPercentage">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- Bar Graphs -->
                        <div class="graph-grid">
                            <div class="graph-card">
                                <h3>اجتماع کارکنان (حلقہ جات) ہوئے</h3>
                                <div class="chart-container">
                                    <canvas id="ijtimaKarkunanHalqajatChart"></canvas>
                                </div>
                            </div>
                            <div class="graph-card">
                                <h3>درس قرآن (حلقہ جات) ہوئے</h3>
                                <div class="chart-container">
                                    <canvas id="darsQuranChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>

        <!-- Spider Graph View -->
        <div id="spider-view" class="view-content">
            <div class="chart-container" style="height: 700px;">
                <canvas id="spiderChart"></canvas>
            </div>
        </div>

        <!-- Report View -->
        <div id="report-view" class="view-content">
            <div style="padding: 20px; background: #f8f9fa; border-radius: 10px; margin-bottom: 20px;">
                <h3>رپورٹ لوڈ ہو رہی ہے...</h3>
                <p>اگر رپورٹ نہیں دکھائی دے رہی تو براؤزر کو ریفریش کریں</p>
            </div>
            <iframe src="{{ url_for('view_report', zila=zila) }}?hide_header=true" width="100%" height="800px" frameborder="0" onload="console.log('Report iframe loaded')" onerror="console.error('Report iframe failed to load')"></iframe>
        </div>
    </div>

    <script>
        console.log('Script loaded - Dynamic scaling enabled for all charts');
        

        
        // Register the datalabels plugin
        try {
            Chart.register(ChartDataLabels);
            console.log('Chart.js datalabels registered successfully');
        } catch (error) {
            console.error('Error registering Chart.js datalabels:', error);
        }

        // Global datalabels configuration
        Chart.defaults.plugins.datalabels = {
            display: true,
            color: '#333',
            anchor: 'end',
            align: 'top',
            offset: 0,
            font: {
                family: 'Noto Nastaliq Urdu, Arial, sans-serif',
                size: 20,
                weight: 'bold'
            },
            formatter: function(value, context) {
                return value;
            }
        };
        
        function showView(viewType) {
            console.log('showView called with:', viewType);
            
            // Hide all views
            document.querySelectorAll('.view-content').forEach(view => {
                view.classList.remove('active');
            });
            
            // Reset all buttons to inactive
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.add('inactive');
                btn.classList.remove('active');
            });
            
            // Show selected view and activate corresponding button
            if (viewType === 'graphs') {
                document.getElementById('graphs-view').classList.add('active');
                document.querySelectorAll('.toggle-btn')[0].classList.add('active');
                document.querySelectorAll('.toggle-btn')[0].classList.remove('inactive');
            } else if (viewType === 'spider') {
                document.getElementById('spider-view').classList.add('active');
                document.querySelectorAll('.toggle-btn')[1].classList.add('active');
                document.querySelectorAll('.toggle-btn')[1].classList.remove('inactive');
                // Initialize spider chart when view is shown
                if (typeof createSpiderChart === 'function') {
                    createSpiderChart();
                }
            } else if (viewType === 'report') {
                console.log('Showing report view');
                document.getElementById('report-view').classList.add('active');
                document.querySelectorAll('.toggle-btn')[2].classList.add('active');
                document.querySelectorAll('.toggle-btn')[2].classList.remove('inactive');
            }
        }

        // Chart.js configuration for bar charts
        const chartConfig = {
            type: 'bar',
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: 30,
                        bottom: 30,
                        left: 80,
                        right: 30
                    }
                },
                                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: true,
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                borderColor: 'rgba(255, 255, 255, 0.2)',
                                borderWidth: 1,
                                cornerRadius: 4,
                                displayColors: false
                            },
                            datalabels: {
                                display: true,
                                color: '#333',
                                anchor: 'center',
                                align: 'bottom',
                                offset: 10,
                                font: {
                                    family: 'Noto Nastaliq Urdu, Arial, sans-serif',
                                    size: 32,
                                    weight: 'bold'
                                },
                                formatter: function(value, context) {
                                    return value;
                                }
                            }
                        },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            display: false
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                family: 'Noto Nastaliq Urdu, Arial, sans-serif',
                                size: 24
                            },
                            color: '#333',
                            maxRotation: 0,
                            minRotation: 0
                        }
                    }
                },
                elements: {
                    bar: {
                        borderWidth: 0,
                        borderRadius: 4,
                        borderSkipped: false,
                        backgroundColor: function(context) {
                            const colors = ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6'];
                            return colors[context.dataIndex % colors.length];
                        }
                    }
                },
                animation: {
                    duration: 500,
                    easing: 'easeOutQuart'
                },
                interaction: {
                    mode: 'index',
                    axis: 'x',
                    intersect: false
                }
            }
        };

        // Tanzeemi Hayyat Charts - Quarterly Comparison
        function createTanzeemiChart(canvasId, data, label) {
            try {
                const canvas = document.getElementById(canvasId);
                if (!canvas) {
                    console.error('Canvas element not found:', canvasId);
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error('Could not get 2D context for canvas:', canvasId);
                    return;
                }
                
                // Extract quarterly data
                const q1Data = data.q1 || { hadaf: 0, izafa: 0 };
                const q2Data = data.q2 || { hadaf: 0, izafa: 0 };
                
                const hadaf = q2Data.hadaf || 0; // Use Q2 target for both quarters
                const q1Izafa = q1Data.izafa || 0;
                const q2Izafa = q2Data.izafa || 0;
                
                // Calculate dynamic scale maximum based on all three values: hadaf, izafa_q1, izafa_q2
                const maxValue = Math.max(hadaf, q1Izafa, q2Izafa);
                const suggestedMax = maxValue > 0 ? Math.ceil(maxValue * 1.2) : 10;
                
                const q1Percentage = hadaf > 0 ? Math.round((q1Izafa / hadaf) * 100) : 0;
                const q2Percentage = hadaf > 0 ? Math.round((q2Izafa / hadaf) * 100) : 0;
                
                // Set labels based on chart type
                let q1Label, q2Label;
                if (canvasId === 'blockCodeChart') {
                    q1Label = ['سہ ماہی اول', `${q1Percentage}%`];
                    q2Label = ['سہ ماہی دوم', `${q2Percentage}%`];
                } else if (canvasId === 'nizamFajarChart' || canvasId === 'awaamiCommitteeChart') {
                    q1Label = ['سہ ماہی اول', `${q1Percentage}%`];
                    q2Label = ['سہ ماہی دوم', `${q2Percentage}%`];
                } else if (canvasId.includes('Ikhtitam')) {
                    if (canvasId === 'nizamFajarIkhtitamChart') {
                        q1Label = ['سہ ماہی اول', `${q1Percentage}%`];
                        q2Label = ['سہ ماہی دوم', `${q2Percentage}%`];
                    } else if (canvasId === 'blockCodeIkhtitamChart') {
                        q1Label = ['سہ ماہی اول', `${q1Percentage}%`];
                        q2Label = ['سہ ماہی دوم', `${q2Percentage}%`];
                    } else if (canvasId === 'awaamiCommitteeIkhtitamChart') {
                        q1Label = ['سہ ماہی اول', `${q1Percentage}%`];
                        q2Label = ['سہ ماہی دوم', `${q2Percentage}%`];
                    } else {
                        q1Label = ['سہ ماہی اول اضافہ', `${q1Percentage}%`];
                        q2Label = ['سہ ماہی دوم اضافہ', `${q2Percentage}%`];
                    }
                } else {
                    q1Label = ['سہ ماہی اول اضافہ', `${q1Percentage}%`];
                    q2Label = ['سہ ماہی دوم اضافہ', `${q2Percentage}%`];
                }
                
                // Destroy existing chart if it exists
                const existingChart = Chart.getChart(canvas);
                if (existingChart) {
                    existingChart.destroy();
                }
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [q1Label, q2Label],
                        datasets: [{
                            label: 'Quarterly Data',
                            data: [q1Izafa, q2Izafa],
                            backgroundColor: ['#6c7a8c', '#48EF62'],
                            borderWidth: 0,
                            categoryPercentage: 0.9,
                            barPercentage: 0.8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 20,
                                bottom: 20,
                                left: 20
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: true,
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                borderColor: 'rgba(255, 255, 255, 0.2)',
                                borderWidth: 1,
                                cornerRadius: 4,
                                displayColors: false,
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        const percentage = context.dataIndex === 0 ? q1Percentage : q2Percentage;
                                        return `${value} (${percentage}%)`;
                                    }
                                }
                            },
                            datalabels: {
                                display: true,
                                color: '#333',
                                anchor: 'end',
                                align: 'top',
                                textAlign: 'center',
                                offset: 0,
                                font: {
                                    family: 'Noto Nastaliq Urdu, Arial, sans-serif',
                                    size: 32,
                                    weight: 'bold'
                                },
                                formatter: function(value, context) {
                                    return value;
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: suggestedMax,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)',
                                    drawBorder: false
                                },
                                ticks: {
                                    display: false
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: {
                                        family: 'Noto Nastaliq Urdu, Arial, sans-serif',
                                        size: 20
                                    },
                                    color: '#333',
                                    maxRotation: 0,
                                    minRotation: 0,
                                    padding: 15
                                }
                            }
                        },
                        elements: {
                            bar: {
                                borderWidth: 0,
                                borderRadius: 4,
                                borderSkipped: false
                            }
                        },
                        animation: {
                            duration: 500,
                            easing: 'easeOutQuart'
                        },
                        interaction: {
                            mode: 'index',
                            axis: 'x',
                            intersect: false
                        }
                    },
                    plugins: [{
                        afterDraw: function(chart) {
                            const ctx = chart.ctx;
                            const yAxis = chart.scales.y;
                            
                            // Draw target line
                            if (hadaf > 0) {
                                const targetY = yAxis.getPixelForValue(hadaf);
                                ctx.save();
                                ctx.strokeStyle = '#8e44ad';
                                ctx.lineWidth = 3;
                                ctx.setLineDash([8, 4]);
                                ctx.beginPath();
                                ctx.moveTo(chart.chartArea.left, targetY);
                                ctx.lineTo(chart.chartArea.right, targetY);
                                ctx.stroke();
                                ctx.restore();
                                
                                // Add target label on the left side
                                ctx.save();
                                ctx.fillStyle = '#8e44ad';
                                ctx.font = 'bold 14px Noto Nastaliq Urdu, Arial, sans-serif';
                                ctx.textAlign = 'center';
                                ctx.fillText(`${hadaf}`, chart.chartArea.left - 10, targetY);
                                ctx.restore();
                            }
                        }
                    }]
                });
            } catch (error) {
                console.error('Error creating chart for', canvasId, ':', error);
                // Show fallback content
                const canvas = document.getElementById(canvasId);
                if (canvas) {
                    canvas.style.display = 'none';
                    const container = canvas.parentElement;
                    if (container) {
                        container.innerHTML += '<div style="text-align: center; padding: 20px; color: #666;">چارٹ لوڈ نہیں ہو سکا</div>';
                    }
                }
            }
        }

        // Afradi Quwat Charts - Quarterly Comparison
        function createAfradiChart(canvasId, data, label) {
            try {
                const canvas = document.getElementById(canvasId);
                if (!canvas) {
                    console.error('Canvas element not found:', canvasId);
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error('Could not get 2D context for canvas:', canvasId);
                    return;
                }
                
                // Extract quarterly data
                const q1Data = data.q1 || { hadaf: 0, izafa: 0 };
                const q2Data = data.q2 || { hadaf: 0, izafa: 0 };
                
                const hadaf = q2Data.hadaf || 0; // Use Q2 target for both quarters
                const q1Izafa = q1Data.izafa || 0;
                const q2Izafa = q2Data.izafa || 0;
                
                // Calculate dynamic scale maximum based on all three values: hadaf, izafa_q1, izafa_q2
                const maxValue = Math.max(hadaf, q1Izafa, q2Izafa);
                const suggestedMax = maxValue > 0 ? Math.ceil(maxValue * 1.2) : 10;
                
                const q1Percentage = hadaf > 0 ? Math.round((q1Izafa / hadaf) * 100) : 0;
                const q2Percentage = hadaf > 0 ? Math.round((q2Izafa / hadaf) * 100) : 0;
                
                // Destroy existing chart if it exists
                const existingChart = Chart.getChart(canvas);
                if (existingChart) {
                    existingChart.destroy();
                }
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [['سہ ماہی اول', `${q1Percentage}%`], ['سہ ماہی دوم', `${q2Percentage}%`]],
                        datasets: [{
                            label: 'Quarterly Data',
                            data: [q1Izafa, q2Izafa],
                            backgroundColor: ['#6c7a8c', '#48EF62'],
                            borderWidth: 0,
                            categoryPercentage: 0.9,
                            barPercentage: 0.8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 20,
                                bottom: 20,
                                left: 20,
                                right: 20
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: true,
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                borderColor: 'rgba(255, 255, 255, 0.2)',
                                borderWidth: 1,
                                cornerRadius: 4,
                                displayColors: false,
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        const percentage = context.dataIndex === 0 ? q1Percentage : q2Percentage;
                                        return `${value} (${percentage}%)`;
                                    }
                                }
                            },
                            datalabels: {
                                display: true,
                                color: '#333',
                                anchor: 'end',
                                align: 'top',
                                textAlign: 'center',
                                offset: 0,
                                font: {
                                    family: 'Noto Nastaliq Urdu, Arial, sans-serif',
                                    size: 32,
                                    weight: 'bold'
                                },
                                formatter: function(value, context) {
                                    return value;
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: suggestedMax,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)',
                                    drawBorder: false
                                },
                                ticks: {
                                    display: false
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: {
                                        family: 'Noto Nastaliq Urdu, Arial, sans-serif',
                                        size: 20
                                    },
                                    color: '#333',
                                    maxRotation: 0,
                                    minRotation: 0,
                                    padding: 15
                                }
                            }
                        },
                        elements: {
                            bar: {
                                borderWidth: 0,
                                borderRadius: 4,
                                borderSkipped: false
                            }
                        },
                        animation: {
                            duration: 500,
                            easing: 'easeOutQuart'
                        },
                        interaction: {
                            mode: 'index',
                            axis: 'x',
                            intersect: false
                        }
                    },
                                            plugins: [{
                        afterDraw: function(chart) {
                            const ctx = chart.ctx;
                            const yAxis = chart.scales.y;
                            
                            // Draw target line
                            if (hadaf > 0) {
                                const targetY = yAxis.getPixelForValue(hadaf);
                                ctx.save();
                                ctx.strokeStyle = '#8e44ad';
                                ctx.lineWidth = 3;
                                ctx.setLineDash([8, 4]);
                                ctx.beginPath();
                                ctx.moveTo(chart.chartArea.right, targetY);
                                ctx.lineTo(chart.chartArea.left, targetY);
                                ctx.stroke();
                                ctx.restore();
                                
                                // Add target label on the left side
                                ctx.save();
                                ctx.fillStyle = '#8e44ad';
                                ctx.font = 'bold 14px Noto Nastaliq Urdu, Arial, sans-serif';
                                ctx.textAlign = 'center';
                                ctx.fillText(` ${hadaf}`, chart.chartArea.left - 10, targetY);
                                ctx.restore();
                            }
                        }
                    }]
                });
            } catch (error) {
                console.error('Error creating chart for', canvasId, ':', error);
                // Show fallback content
                const canvas = document.getElementById(canvasId);
                if (canvas) {
                    canvas.style.display = 'none';
                    const container = canvas.parentElement;
                    if (container) {
                        container.innerHTML += '<div style="text-align: center; padding: 20px; color: #666;">چارٹ لوڈ نہیں ہو سکا</div>';
                    }
                }
            }
        }

        // Ijtimaat Charts - Quarterly Comparison
        function createIjtimaatChart(canvasId, data, label) {
            try {
                const canvas = document.getElementById(canvasId);
                if (!canvas) {
                    console.error('Canvas element not found:', canvasId);
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error('Could not get 2D context for canvas:', canvasId);
                    return;
                }
                
                // Extract quarterly data
                const q1Data = data.q1 || { planned: 0, held: 0 };
                const q2Data = data.q2 || { planned: 0, held: 0 };
                
                const planned = q2Data.planned || 0; // Use Q2 planned for both quarters
                const q1Held = q1Data.held || 0;
                const q2Held = q2Data.held || 0;
                
                // Calculate dynamic scale maximum based on all three values: tay_shuda, houye_q1, houye_q2
                const maxValue = Math.max(planned, q1Held, q2Held);
                const suggestedMax = maxValue > 0 ? Math.ceil(maxValue * 1.2) : 10;
                
                const q1Percentage = planned > 0 ? Math.round((q1Held / planned) * 100) : 0;
                const q2Percentage = planned > 0 ? Math.round((q2Held / planned) * 100) : 0;
                
                // Destroy existing chart if it exists
                const existingChart = Chart.getChart(canvas);
                if (existingChart) {
                    existingChart.destroy();
                }
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [['سہ ماہی اول', `${q1Percentage}%`], ['سہ ماہی دوم', `${q2Percentage}%`]],
                        datasets: [{
                            label: 'Quarterly Data',
                            data: [q1Held, q2Held],
                            backgroundColor: ['#6c7a8c', '#48EF62'],
                            borderWidth: 0,
                            categoryPercentage: 0.9,
                            barPercentage: 0.8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 20,
                                bottom: 20,
                                left: 20,
                                right: 20
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: true,
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                borderColor: 'rgba(255, 255, 255, 0.2)',
                                borderWidth: 1,
                                cornerRadius: 4,
                                displayColors: false,
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        const percentage = context.dataIndex === 0 ? q1Percentage : q2Percentage;
                                        return `${value} (${percentage}%)`;
                                    }
                                }
                            },
                            datalabels: {
                                display: true,
                                color: '#333',
                                anchor: 'end',
                                align: 'top',
                                textAlign: 'center',
                                offset: 0,
                                font: {
                                    family: 'Noto Nastaliq Urdu, Arial, sans-serif',
                                    size: 32,
                                    weight: 'bold'
                                },
                                formatter: function(value, context) {
                                    return value;
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: suggestedMax,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)',
                                    drawBorder: false
                                },
                                ticks: {
                                    display: false
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: {
                                        family: 'Noto Nastaliq Urdu, Arial, sans-serif',
                                        size: 20
                                    },
                                    color: '#333',
                                    maxRotation: 0,
                                    minRotation: 0,
                                    padding: 15
                                }
                            }
                        },
                        elements: {
                            bar: {
                                borderWidth: 0,
                                borderRadius: 4,
                                borderSkipped: false
                            }
                        },
                        animation: {
                            duration: 500,
                            easing: 'easeOutQuart'
                        },
                        interaction: {
                            mode: 'index',
                            axis: 'x',
                            intersect: false
                        }
                    },
                                            plugins: [{
                        afterDraw: function(chart) {
                            const ctx = chart.ctx;
                            const yAxis = chart.scales.y;
                            
                            // Draw target line
                            if (planned > 0) {
                                const targetY = yAxis.getPixelForValue(planned);
                                ctx.save();
                                ctx.strokeStyle = '#8e44ad';
                                ctx.lineWidth = 3;
                                ctx.setLineDash([8, 4]);
                                ctx.beginPath();
                                ctx.moveTo(chart.chartArea.left, targetY);
                                ctx.lineTo(chart.chartArea.right, targetY);
                                ctx.stroke();
                                ctx.restore();
                                
                                // Add target label on the left side
                                ctx.save();
                                ctx.fillStyle = '#8e44ad';
                                ctx.font = 'bold 14px Noto Nastaliq Urdu, Arial, sans-serif';
                                ctx.textAlign = 'center';
                                ctx.fillText(` ${planned}`, chart.chartArea.left - 10, targetY);
                                ctx.restore();
                            }
                        }
                    }]
                });
            } catch (error) {
                console.error('Error creating chart for', canvasId, ':', error);
                // Show fallback content
                const canvas = document.getElementById(canvasId);
                if (canvas) {
                    canvas.style.display = 'none';
                    const container = canvas.parentElement;
                    if (container) {
                        container.innerHTML += '<div style="text-align: center; padding: 20px; color: #666;">چارٹ لوڈ نہیں ہو سکا</div>';
                    }
                }
            }
        }

        // Spider Chart Function - Updated for quarterly data
        function calculatePercentage(data, type) {
            let percentage = 0;
            if (type === 'tanzeemi' || type === 'afradi') {
                const q2Data = data.q2 || {};
                const hadaf = q2Data.hadaf || 0;
                const izafa = q2Data.izafa || 0;
                percentage = hadaf > 0 ? Math.round((izafa / hadaf) * 100) : 0;
            } else {
                const q2Data = data.q2 || {};
                const planned = q2Data.planned || 0;
                const held = q2Data.held || 0;
                percentage = planned > 0 ? Math.round((held / planned) * 100) : 0;
            }
            return percentage;
        }

        // Create Spider Chart
        function createSpiderChart() {
            const blockCodeIkhtitamData = JSON.parse('{{ block_code_ikhtitam_data | tojson | safe }}');
            const nizamFajarData = JSON.parse('{{ nizam_fajar_data | tojson | safe }}');
            const awaamiCommitteeData = JSON.parse('{{ awaami_committee_data | tojson | safe }}');
            const arkaanData = JSON.parse('{{ arkaan_data | tojson | safe }}');
            const umeedwaranData = JSON.parse('{{ umeedwaran_data | tojson | safe }}');
            const karkunanData = JSON.parse('{{ karkunan_data | tojson | safe }}');
            const ijtimaKarkunanAlaqahData = JSON.parse('{{ ijtima_karkunan_alaqah_data | tojson | safe }}');
            const ijtimaKarkunanHalqajatData = JSON.parse('{{ ijtima_karkunan_halqajat_data | tojson | safe }}');
            const darsQuranData = JSON.parse('{{ dars_quran_data | tojson | safe }}');
            const gharonTakDawatData = JSON.parse('{{ gharon_tak_dawat_data | tojson | safe }}');
            const taqseemLiteratureData = JSON.parse('{{ taqseem_literature_data | tojson | safe }}');

            const labels = [
                `بلاک کوڈ انچارجز اختتام (${calculatePercentage(blockCodeIkhtitamData, 'tanzeemi')}%)`,
                `نظام فجر (${calculatePercentage(nizamFajarData, 'tanzeemi')}%)`,
                `عوامی کمیٹی (${calculatePercentage(awaamiCommitteeData, 'tanzeemi')}%)`,
                `ارکان سازی (${calculatePercentage(arkaanData, 'afradi')}%)`,
                `امیدواران رکنیت (${calculatePercentage(umeedwaranData, 'afradi')}%)`,
                `کارکنان (${calculatePercentage(karkunanData, 'afradi')}%)`,
                `اجتماع کارکنان (علاقہ) (${calculatePercentage(ijtimaKarkunanAlaqahData, 'ijtimaat')}%)`,
                `اجتماع کارکنان (حلقہ جات) (${calculatePercentage(ijtimaKarkunanHalqajatData, 'ijtimaat')}%)`,
                `درس قرآن (حلقہ جات) (${calculatePercentage(darsQuranData, 'ijtimaat')}%)`,
                `گھروں تک دعوت (${calculatePercentage(gharonTakDawatData, 'ijtimaat')}%)`,
                `تقسیم لٹریچر (${calculatePercentage(taqseemLiteratureData, 'ijtimaat')}%)`
            ];

            const percentages = [
                calculatePercentage(blockCodeIkhtitamData, 'tanzeemi'),
                calculatePercentage(nizamFajarData, 'tanzeemi'),
                calculatePercentage(awaamiCommitteeData, 'tanzeemi'),
                calculatePercentage(arkaanData, 'afradi'),
                calculatePercentage(umeedwaranData, 'afradi'),
                calculatePercentage(karkunanData, 'afradi'),
                calculatePercentage(ijtimaKarkunanAlaqahData, 'ijtimaat'),
                calculatePercentage(ijtimaKarkunanHalqajatData, 'ijtimaat'),
                calculatePercentage(darsQuranData, 'ijtimaat'),
                calculatePercentage(gharonTakDawatData, 'ijtimaat'),
                calculatePercentage(taqseemLiteratureData, 'ijtimaat')
            ];

            const maxValue = Math.ceil(Math.max(...percentages) / 10) * 10;

            // Destroy existing chart if it exists
            const existingChart = Chart.getChart('spiderChart');
            if (existingChart) {
                existingChart.destroy();
            }

            new Chart(document.getElementById('spiderChart').getContext('2d'), {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'کارکردگی کا فیصد',
                        data: percentages,
                        backgroundColor: 'rgba(46, 204, 113, 0.4)',
                        borderColor: 'rgba(46, 204, 113, 1)',
                        borderWidth: 3,
                        pointBackgroundColor: 'rgba(46, 204, 113, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: 'rgba(39, 174, 96, 1)',
                        pointHoverBorderColor: '#fff',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: maxValue,
                            min: 0,
                            ticks: {
                                display: false
                            },
                            pointLabels: {
                                font: {
                                    family: 'Noto Nastaliq Urdu, serif',
                                    size: 12,
                                    weight: 'bold'
                                },
                                color: '#333',
                                padding: 15
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            angleLines: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    family: 'Noto Nastaliq Urdu, serif',
                                    size: 16
                                },
                                color: '#333'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.r;
                                    return `${value}%`;
                                }
                            }
                        },
                        datalabels: {
                            display: false
                        }
                    }
                }
            });
        }



        // Function to populate data tables with quarterly comparison
        function populateDataTables() {
            // Tanzeemi Hayyat Data (using ikhtitam data for tables)
            const blockCodeIkhtitamData = JSON.parse('{{ block_code_ikhtitam_data | tojson | safe }}');
            const nizamFajarIkhtitamData = JSON.parse('{{ nizam_fajar_ikhtitam_data | tojson | safe }}');
            const awaamiCommitteeIkhtitamData = JSON.parse('{{ awaami_committee_ikhtitam_data | tojson | safe }}');

            // Afradi Quwat Data
            const arkaanData = JSON.parse('{{ arkaan_data | tojson | safe }}');
            const umeedwaranData = JSON.parse('{{ umeedwaran_data | tojson | safe }}');
            const karkunanData = JSON.parse('{{ karkunan_data | tojson | safe }}');

            // Ijtimaat Data
            const zilaiShuraData = JSON.parse('{{ zilai_shura_data | tojson | safe }}');
            const nazmZilaData = JSON.parse('{{ nazm_zila_data | tojson | safe }}');
            const naziminAlaqajatData = JSON.parse('{{ nazimin_alaqajat_data | tojson | safe }}');
            const zilaiIjtimaArkaanData = JSON.parse('{{ zilai_ijtima_arkaan_data | tojson | safe }}');
            const zilaiIjtimaUmeedwaranData = JSON.parse('{{ zilai_ijtima_umeedwaran_data | tojson | safe }}');
            const ijtimaArkaanAlaqahData = JSON.parse('{{ ijtima_arkaan_alaqah_data | tojson | safe }}');
            const ijtimaUmeedwaranAlaqahData = JSON.parse('{{ ijtima_umeedwaran_alaqah_data | tojson | safe }}');
            const ijtimaKarkunanAlaqahData = JSON.parse('{{ ijtima_karkunan_alaqah_data | tojson | safe }}');
            const ijtimaKarkunanHalqajatData = JSON.parse('{{ ijtima_karkunan_halqajat_data | tojson | safe }}');
            const ijtimaNaziminHalqajatData = JSON.parse('{{ ijtima_nazimin_halqajat_data | tojson | safe }}');

            // Dawati Data
            const darsQuranData = JSON.parse('{{ dars_quran_data | tojson | safe }}');
            const dawatiCampData = JSON.parse('{{ dawati_camp_data | tojson | safe }}');
            const gharonTakDawatData = JSON.parse('{{ gharon_tak_dawat_data | tojson | safe }}');
            const taqseemLiteratureData = JSON.parse('{{ taqseem_literature_data | tojson | safe }}');

            // Helper function to get quarterly data
            function getQuarterlyData(data, field) {
                const q1Data = data.q1 || {};
                const q2Data = data.q2 || {};
                return {
                    q1: q1Data[field] || 0,
                    q2: q2Data[field] || 0
                };
            }

            // Tanzeemi Hayyat - Block Code (using ikhtitam data)
            const blockCodeTarget = getQuarterlyData(blockCodeIkhtitamData, 'hadaf');
            const blockCodeIkhtitam = getQuarterlyData(blockCodeIkhtitamData, 'izafa');
            document.getElementById('blockCodeTarget').textContent = blockCodeTarget.q2 || 0;
            document.getElementById('blockCodeIzafa').textContent = `${blockCodeIkhtitam.q1} / ${blockCodeIkhtitam.q2}`;
            const blockCodeQ1Percentage = blockCodeTarget.q2 > 0 ? Math.round((blockCodeIkhtitam.q1 / blockCodeTarget.q2) * 100) : 0;
            const blockCodeQ2Percentage = blockCodeTarget.q2 > 0 ? Math.round((blockCodeIkhtitam.q2 / blockCodeTarget.q2) * 100) : 0;
            document.getElementById('blockCodePercentageQ1').textContent = blockCodeQ1Percentage + '%';
            document.getElementById('blockCodePercentage').textContent = blockCodeQ2Percentage + '%';

            // Tanzeemi Hayyat - Nizam Fajar (using ikhtitam data)
            const nizamFajarTarget = getQuarterlyData(nizamFajarIkhtitamData, 'hadaf');
            const nizamFajarIkhtitam = getQuarterlyData(nizamFajarIkhtitamData, 'izafa');
            document.getElementById('nizamFajarTarget').textContent = nizamFajarTarget.q2 || 0;
            document.getElementById('nizamFajarIzafa').textContent = `${nizamFajarIkhtitam.q1} / ${nizamFajarIkhtitam.q2}`;
            const nizamFajarQ1Percentage = nizamFajarTarget.q2 > 0 ? Math.round((nizamFajarIkhtitam.q1 / nizamFajarTarget.q2) * 100) : 0;
            const nizamFajarQ2Percentage = nizamFajarTarget.q2 > 0 ? Math.round((nizamFajarIkhtitam.q2 / nizamFajarTarget.q2) * 100) : 0;
            document.getElementById('nizamFajarPercentageQ1').textContent = nizamFajarQ1Percentage + '%';
            document.getElementById('nizamFajarPercentage').textContent = nizamFajarQ2Percentage + '%';

            // Tanzeemi Hayyat - Awaami Committee (using ikhtitam data)
            const awaamiCommitteeTarget = getQuarterlyData(awaamiCommitteeIkhtitamData, 'hadaf');
            const awaamiCommitteeIkhtitam = getQuarterlyData(awaamiCommitteeIkhtitamData, 'izafa');
            document.getElementById('awaamiCommitteeTarget').textContent = awaamiCommitteeTarget.q2 || 0;
            document.getElementById('awaamiCommitteeIzafa').textContent = `${awaamiCommitteeIkhtitam.q1} / ${awaamiCommitteeIkhtitam.q2}`;
            const awaamiCommitteeQ1Percentage = awaamiCommitteeTarget.q2 > 0 ? Math.round((awaamiCommitteeIkhtitam.q1 / awaamiCommitteeTarget.q2) * 100) : 0;
            const awaamiCommitteeQ2Percentage = awaamiCommitteeTarget.q2 > 0 ? Math.round((awaamiCommitteeIkhtitam.q2 / awaamiCommitteeTarget.q2) * 100) : 0;
            document.getElementById('awaamiCommitteePercentageQ1').textContent = awaamiCommitteeQ1Percentage + '%';
            document.getElementById('awaamiCommitteePercentage').textContent = awaamiCommitteeQ2Percentage + '%';

            // Afradi Quwat - Arkaan
            const arkaanTarget = getQuarterlyData(arkaanData, 'hadaf');
            const arkaanIzafa = getQuarterlyData(arkaanData, 'izafa');
            document.getElementById('arkaanTarget').textContent = arkaanTarget.q2 || 0;
            document.getElementById('arkaanIzafa').textContent = `${arkaanIzafa.q1} / ${arkaanIzafa.q2}`;
            const arkaanQ2Percentage = arkaanTarget.q2 > 0 ? Math.round((arkaanIzafa.q2 / arkaanTarget.q2) * 100) : 0;
            document.getElementById('arkaanPercentage').textContent = arkaanQ2Percentage + '%';

            // Afradi Quwat - Umeedwaran
            const umeedwaranTarget = getQuarterlyData(umeedwaranData, 'hadaf');
            const umeedwaranIzafa = getQuarterlyData(umeedwaranData, 'izafa');
            document.getElementById('umeedwaranTarget').textContent = umeedwaranTarget.q2 || 0;
            document.getElementById('umeedwaranIzafa').textContent = `${umeedwaranIzafa.q1} / ${umeedwaranIzafa.q2}`;
            const umeedwaranQ2Percentage = umeedwaranTarget.q2 > 0 ? Math.round((umeedwaranIzafa.q2 / umeedwaranTarget.q2) * 100) : 0;
            document.getElementById('umeedwaranPercentage').textContent = umeedwaranQ2Percentage + '%';

            // Afradi Quwat - Karkunan
            const karkunanTarget = getQuarterlyData(karkunanData, 'hadaf');
            const karkunanIzafa = getQuarterlyData(karkunanData, 'izafa');
            document.getElementById('karkunanTarget').textContent = karkunanTarget.q2 || 0;
            document.getElementById('karkunanIzafa').textContent = `${karkunanIzafa.q1} / ${karkunanIzafa.q2}`;
            const karkunanQ2Percentage = karkunanTarget.q2 > 0 ? Math.round((karkunanIzafa.q2 / karkunanTarget.q2) * 100) : 0;
            document.getElementById('karkunanPercentage').textContent = karkunanQ2Percentage + '%';

            // Combined Ijtimaat - Ijtima Karkunan Halqajat
            const ijtimaKarkunanHalqajatPlanned = getQuarterlyData(ijtimaKarkunanHalqajatData, 'planned');
            const ijtimaKarkunanHalqajatHeld = getQuarterlyData(ijtimaKarkunanHalqajatData, 'held');
            document.getElementById('ijtimaKarkunanHalqajatPlanned').textContent = ijtimaKarkunanHalqajatPlanned.q2 || 0;
            document.getElementById('ijtimaKarkunanHalqajatHeld').textContent = `${ijtimaKarkunanHalqajatHeld.q1} / ${ijtimaKarkunanHalqajatHeld.q2}`;
            const ijtimaKarkunanHalqajatQ2Percentage = ijtimaKarkunanHalqajatPlanned.q2 > 0 ? Math.round((ijtimaKarkunanHalqajatHeld.q2 / ijtimaKarkunanHalqajatPlanned.q2) * 100) : 0;
            document.getElementById('ijtimaKarkunanHalqajatPercentage').textContent = ijtimaKarkunanHalqajatQ2Percentage + '%';

            // Combined Ijtimaat - Dars Quran
            const darsQuranPlanned = getQuarterlyData(darsQuranData, 'planned');
            const darsQuranHeld = getQuarterlyData(darsQuranData, 'held');
            document.getElementById('darsQuranPlanned').textContent = darsQuranPlanned.q2 || 0;
            document.getElementById('darsQuranHeld').textContent = `${darsQuranHeld.q1} / ${darsQuranHeld.q2}`;
            const darsQuranQ2Percentage = darsQuranPlanned.q2 > 0 ? Math.round((darsQuranHeld.q2 / darsQuranPlanned.q2) * 100) : 0;
            document.getElementById('darsQuranPercentage').textContent = darsQuranQ2Percentage + '%';
        }

        // Function to ensure proper chart initialization
        function initializeCharts() {
            // Wait for fonts to load
            if (document.fonts && document.fonts.ready) {
                document.fonts.ready.then(function() {
                    createAllCharts();
                });
            } else {
                // Fallback for browsers that don't support document.fonts
                setTimeout(createAllCharts, 1000);
            }
        }

        // Function to add datalabels to all charts (simplified to prevent flickering)
        function addDataLabelsToCharts() {
            // This function is now simplified to prevent multiple updates
            console.log('Datalabels function called - charts should be configured during creation');
        }

        function createAllCharts() {
            try {
                // Tanzeemi Hayyat Ikhtitam Charts
                createTanzeemiChart('blockCodeIkhtitamChart', JSON.parse('{{ block_code_ikhtitam_data | tojson | safe }}'), 'بلاک کوڈ انچارجز اختتام');
                createTanzeemiChart('nizamFajarIkhtitamChart', JSON.parse('{{ nizam_fajar_ikhtitam_data | tojson | safe }}'), 'نظام فجر اختتام');
                createTanzeemiChart('awaamiCommitteeIkhtitamChart', JSON.parse('{{ awaami_committee_ikhtitam_data | tojson | safe }}'), 'عوامی کمیٹی اختتام');

                // Afradi Quwat Charts
                createAfradiChart('arkaanChart', JSON.parse('{{ arkaan_data | tojson | safe }}'), 'ارکان');
                createAfradiChart('umeedwaranChart', JSON.parse('{{ umeedwaran_data | tojson | safe }}'), 'امیدواران رکنیت');
                createAfradiChart('karkunanChart', JSON.parse('{{ karkunan_data | tojson | safe }}'), 'کارکنان');

                // Combined Ijtimaat Charts - Only اجتماع کارکنان (حلقہ جات) and درس قرآن (حلقہ جات)
                createIjtimaatChart('ijtimaKarkunanHalqajatChart', JSON.parse('{{ ijtima_karkunan_halqajat_data | tojson | safe }}'), 'اجتماع کارکنان (حلقہ جات)');
                createIjtimaatChart('darsQuranChart', JSON.parse('{{ dars_quran_data | tojson | safe }}'), 'درس قرآن (حلقہ جات)');

                // Populate data tables
                populateDataTables();
                
                // Charts are now configured during creation to prevent flickering
            } catch (error) {
                console.error('Error initializing charts:', error);
                // Retry after a short delay
                setTimeout(createAllCharts, 500);
            }
        }

        // Initialize charts with data from Flask
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded');
            
            try {
            
            // Add event listeners to all toggle buttons
            const buttons = document.querySelectorAll('.toggle-btn');
            console.log('Found', buttons.length, 'toggle buttons');
            
            buttons.forEach((button, index) => {
                console.log('Adding listener to button', index, 'with data-view:', button.getAttribute('data-view'));
                button.addEventListener('click', function(e) {
                    console.log('Button clicked!');
                    e.preventDefault();
                    e.stopPropagation();
                    const viewType = this.getAttribute('data-view');
                    console.log('Button clicked:', viewType);
                    showView(viewType);
                });
            });
            
            // Check if report button exists
            const reportBtn = document.getElementById('report-btn');
            if (reportBtn) {
                console.log('Report button found');
            } else {
                console.log('Report button not found');
            }
            
            // Check if report view exists
            const reportView = document.getElementById('report-view');
            if (reportView) {
                console.log('Report view found');
            } else {
                console.log('Report view not found');
            }
            
            // Ensure Chart.js is loaded
            if (typeof Chart !== 'undefined') {
                // Add a small delay to ensure stable initialization
                setTimeout(initializeCharts, 50);
            } else {
                // Wait for Chart.js to load
                const checkChartJS = setInterval(function() {
                    if (typeof Chart !== 'undefined') {
                        clearInterval(checkChartJS);
                        setTimeout(initializeCharts, 50);
                    }
                }, 100);
            }
            } catch (error) {
                console.error('Error in DOMContentLoaded:', error);
            }
        });

        // Handle window resize for better responsiveness (simplified to prevent flickering)
        window.addEventListener('resize', function() {
            // Only resize charts if they exist and are stable
            setTimeout(function() {
                Chart.instances.forEach(function(chart) {
                    if (chart && chart.resize) {
                        chart.resize();
                    }
                });
            }, 100);
        });
        
        // Backup event listener
        window.addEventListener('load', function() {
            console.log('Window loaded');
            const buttons = document.querySelectorAll('.toggle-btn');
            console.log('Window load - Found', buttons.length, 'toggle buttons');
        });
    </script>
</body>
</html> 
